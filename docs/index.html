<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#3498db">
  <meta name="description" content="Weather forecast – table & chart">
  <title>Weather Forecast</title>

  <link rel="manifest" href="/manifest.json">

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@0.454.0"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #3498db;
      --bg: #f5f5f5;
      --card: white;
      --text: #333;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      padding: 1rem;
      line-height: 1.5;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.2rem;
      font-size: clamp(1.6rem, 5vw, 2.2rem);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .controls input, .controls button, .controls label {
      padding: 0.55rem 1.1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .controls button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .controls button:hover { background: #2980b9; }
    .filter.active { background: #2c3e50 !important; color: white; }
    .lucide {
      width: 1.4em;
      height: 1.4em;
      stroke-width: 2;
    }
    #current {
      margin: 0 auto 1.5rem;
      max-width: 640px;
      padding: 1.3rem;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 1.3rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    #currentIcon .lucide { width: 90px; height: 90px; stroke-width: 1.4; }
    #currentText h2 { margin: 0; font-size: 1.6rem; }
    #currentTemp { font-size: 2.8rem; font-weight: 700; }
    #status { text-align: center; min-height: 3rem; padding: 1rem; }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid var(--primary);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: 1.5rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #error { color: #c0392b; font-weight: bold; }
    table#forecast {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto 2rem;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    #forecast th, #forecast td {
      padding: 0.8rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    #forecast th { background: #f8f9fa; font-weight: 600; }
    #forecast tr:hover { background: #f0f8ff; }
    #forecast .lucide { width: 48px; height: 48px; stroke-width: 1.6; }
    #chartContainer {
      width: 100%;
      max-width: 1000px;
      height: clamp(320px, 65vh, 480px);
      margin: 0 auto;
      position: relative;
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    canvas { width: 100% !important; height: 100% !important; }

    @media (max-width: 640px) {
      body { padding: 0.8rem; }
      .controls { flex-direction: column; align-items: stretch; }
      #current { flex-direction: column; text-align: center; padding: 1rem; }
      #currentTemp { font-size: 2.4rem; }
      #forecast th, #forecast td { font-size: 0.92rem; padding: 0.7rem; }
    }
  </style>
</head>
<body>

<h1>Weather Forecast</h1>

<div class="controls">
  <input id="city" placeholder="City (e.g. Tournus, FR)" value="">
  <button id="loadBtn"><i data-lucide="search" class="lucide"></i> Load</button>
  <button id="saveBtn"><i data-lucide="bookmark" class="lucide"></i> Save</button>
  <button id="refreshBtn"><i data-lucide="refresh-cw" class="lucide"></i></button>

  <button class="filter" data-range="24">24 h</button>
  <button class="filter" data-range="72">3 d</button>
  <button class="filter" data-range="120">5 d</button>

  <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:0.4rem;">
    <label><input type="radio" name="metric" value="rain" checked> Rain %</label>
    <label><input type="radio" name="metric" value="wind"> Wind</label>
    <label><input type="radio" name="metric" value="both"> Both</label>
  </div>
</div>

<div id="current" style="display:none;">
  <div id="currentIcon"></div>
  <div id="currentText">
    <h2 id="currentCity"></h2>
    <div id="currentTemp"></div>
    <div id="currentFeels"></div>
    <div id="currentDesc"></div>
  </div>
</div>

<div id="status"></div>

<table id="forecast" hidden>
  <thead>
    <tr>
      <th>Time</th>
      <th></th>
      <th>Weather</th>
      <th>Temp</th>
      <th>Feels</th>
      <th>Wind</th>
      <th>Rain %</th>
      <th>Type</th>
      <th>UV</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="chartContainer">
  <canvas id="myChart"></canvas>
</div>

<script>
// ────────────────────────────────────────────────
const API_KEY = 'ca699b20eac9fac41390137b6cbfc66b'; // ← replace

// Lucide icon mapping
function getWeatherIcon(desc = '') {
  const s = desc.toLowerCase();
  if (s.includes('rain') || s.includes('shower') || s.includes('drizzle')) return 'cloud-rain';
  if (s.includes('snow')) return 'snowflake';
  if (s.includes('thunder') || s.includes('storm')) return 'cloud-lightning';
  if (s.includes('cloud')) return 'cloud';
  if (s.includes('fog') || s.includes('mist')) return 'cloud-fog';
  if (s.includes('clear') || s.includes('sunny')) return 'sun';
  return 'cloud';
}

// Elements
const cityInp    = document.getElementById('city');
const loadBtn    = document.getElementById('loadBtn');
const saveBtn    = document.getElementById('saveBtn');
const refreshBtn = document.getElementById('refreshBtn');
const statusDiv  = document.getElementById('status');
const table      = document.getElementById('forecast');
const tbody      = table.tBodies[0];
const filterBtns = document.querySelectorAll('.filter');
const metricRadios = document.querySelectorAll('input[name="metric"]');
const ctx        = document.getElementById('myChart').getContext('2d');

let fullData = [];
let chart = null;
let currentUV = 0;

// ────────────────────────────────────────────────
// Service Worker + update handling
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => {
        reg.addEventListener('updatefound', () => {
          const installing = reg.installing;
          if (installing) {
            installing.addEventListener('statechange', () => {
              if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('New version available. Reload now?')) {
                  window.location.reload();
                }
              }
            });
          }
        });
      })
      .catch(err => console.warn('Service Worker failed:', err));
  });
}

// ────────────────────────────────────────────────
// Init Lucide once
lucide.createIcons();

// Load saved city
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('weatherCity');
  if (saved) {
    cityInp.value = saved;
    fetchForecast(saved);
  }
  lucide.createIcons();
});

// Handlers
loadBtn.onclick    = () => { const c = cityInp.value.trim(); if (c) fetchForecast(c); };
saveBtn.onclick    = () => { const c = cityInp.value.trim(); if (c) { localStorage.setItem('weatherCity', c); alert('City saved'); } };
refreshBtn.onclick = () => { const c = cityInp.value.trim(); if (c) fetchForecast(c); };

filterBtns.forEach(btn => {
  btn.onclick = () => {
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const hrs = Number(btn.dataset.range);
    displayRows(hrs);
    updateChart(hrs);
  };
});

metricRadios.forEach(r => r.onchange = () => updateChart(tbody.children.length || 24));

// ────────────────────────────────────────────────
async function fetchForecast(city) {
  statusDiv.innerHTML = '<div class="loader"></div>';
  table.hidden = true;
  tbody.innerHTML = '';
  fullData = [];
  document.getElementById('current').style.display = 'none';

  try {
    // Geocoding
    const geo = await (await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=${API_KEY}`)).json();
    if (!geo.length) throw new Error('City not found');
    const { lat, lon, name, country } = geo[0];

    // Current
    const cur = await (await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${API_KEY}`)).json();
    currentUV = Math.round(cur.uvi ?? 0);
    const curDesc = cur.weather?.[0]?.description ?? '—';
    const curIcon = getWeatherIcon(curDesc);
    const curTemp = Math.round(cur.main.temp);
    const feels = Math.round(cur.main.feels_like);

    document.getElementById('currentCity').textContent = `${name}, ${country}`;
    document.getElementById('currentTemp').textContent = `${curTemp}°C`;
    document.getElementById('currentFeels').textContent = `Feels like ${feels}°C`;
    document.getElementById('currentDesc').textContent = curDesc;
    document.getElementById('currentIcon').innerHTML = `<i data-lucide="${curIcon}" class="lucide"></i>`;
    document.getElementById('current').style.display = 'flex';

    // Forecast
    const forecast = await (await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${API_KEY}`)).json();
    if (!forecast.list) throw new Error('No forecast data');

    forecast.list.forEach(block => {
      const start = new Date(block.dt * 1000);
      const temp = Math.round(block.main.temp);
      const feels_like = Math.round(block.main.feels_like);
      const windKmh = Math.round((block.wind?.speed || 0) * 3.6);
      const windDir = degToCompass(block.wind?.deg || 0);
      const precipProb = Math.round((block.pop || 0) * 100);
      const precipType = block.rain?.['3h'] ? 'Rain' : block.snow?.['3h'] ? 'Snow' : 'None';
      const summary = block.weather?.[0]?.description || '—';
      const iconName = getWeatherIcon(summary);
      const hour = start.getHours();
      const uv = (hour >= 6 && hour <= 18) ? currentUV : 0;

      for (let i = 0; i < 3; i++) {
        const t = new Date(start.getTime() + i * 3600000);
        const dateStr = t.toLocaleDateString(undefined, {month:'short', day:'numeric'});
        const hourStr = t.getHours().toString().padStart(2,'0') + ':00';
        fullData.push({
          datetime: `${dateStr} ${hourStr}`,
          iconName, summary, temp, feels_like, windKmh, windDir, precipProb, precipType, uv
        });
      }
    });

    statusDiv.innerHTML = '';
    document.querySelector('.filter[data-range="24"]').click();
    lucide.createIcons();

  } catch (err) {
    statusDiv.innerHTML = `<div id="error">Error: ${err.message}</div>`;
  }
}

function degToCompass(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16] || '?';
}

function displayRows(hours) {
  tbody.innerHTML = '';
  const slice = fullData.slice(0, hours);
  slice.forEach(r => {
    const tr = document.createElement('tr');
    if (r.precipProb > 60) tr.style.background = '#e3f2fd';
    else if (r.windKmh > 40) tr.style.background = '#fff3e0';

    tr.innerHTML = `
      <td>${r.datetime}</td>
      <td><i data-lucide="${r.iconName}" class="lucide"></i></td>
      <td style="text-transform:capitalize;">${r.summary}</td>
      <td>${r.temp}°C</td>
      <td>${r.feels_like}°C</td>
      <td>${r.windKmh} km/h ${r.windDir}</td>
      <td>${r.precipProb}</td>
      <td>${r.precipType}</td>
      <td>${r.uv}</td>
    `;
    tbody.appendChild(tr);
  });
  table.hidden = !slice.length;
  lucide.createIcons();
}

function updateChart(hours) {
  if (chart) chart.destroy();
  const mode = document.querySelector('input[name="metric"]:checked')?.value || 'rain';
  const data = fullData.slice(0, hours);
  const labels = data.map(d => d.datetime);
  const temps = data.map(d => d.temp);
  const rains = data.map(d => d.precipProb);
  const winds = data.map(d => d.windKmh);

  const datasets = [{
    label: 'Temperature (°C)',
    data: temps,
    yAxisID: 'y',
    borderColor: 'rgb(75,192,192)',
    tension: 0.25,
    pointRadius: 3
  }];

  if (mode === 'rain' || mode === 'both') {
    datasets.push({
      label: 'Rain %',
      data: rains,
      yAxisID: 'yRight',
      borderColor: 'rgb(54,162,235)',
      tension: 0.25
    });
  }
  if (mode === 'wind' || mode === 'both') {
    datasets.push({
      label: 'Wind (km/h)',
      data: winds,
      yAxisID: mode === 'both' ? 'yRight2' : 'yRight',
      borderColor: 'rgb(255,159,64)',
      tension: 0.25,
      borderDash: mode === 'both' ? [5,3] : []
    });
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { ticks: { maxTicksLimit: 10, maxRotation: 45, autoSkip: true } },
        y: { position: 'left', suggestedMin: -5, suggestedMax: 40 },
        yRight: { position: 'right', min: 0, grid: { drawOnChartArea: false } },
        yRight2: { position: 'right', min: 0, display: mode === 'both', grid: { drawOnChartArea: false } }
      },
      plugins: { legend: { position: 'top' } }
    }
  });
}
</script>
</body>
</html>